{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="app-title">Expense Tracker</h1>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i>
            </div>
        </header>

        <!-- Financial Summary Cards -->
        <div class="summary-grid">
            <!-- Income Card -->
                <div class="summary-card income-card">
                    <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-content">
                        <h3>Total Income</h3>
                        <div class="amount">${{ month_income|default:"0" }}</div>
                    </div>
                </div>
                <form action="{% url 'add_income' %}">
                <button class="add-btn add-income-btn">
                        <i class="fas fa-plus"></i> Add Income
                </button>
                </form>
            </div>
            
            <!-- Expense Card -->
            <div class="summary-card expense-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="card-content">
                        <h3>Total Expenses</h3>
                        <div class="amount">${{ month_expense|default:"0" }}</div>
                    </div>
                </div>
                <form action="{% url 'add_expense' %}">
                <button class="add-btn add-expense-btn">
                    <i class="fas fa-plus"></i> Add Expense
                </button>
                </form>
            </div>

            <div class="summary-card balance-card">
                <div class="card-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="card-content">
                    <h3>Balance</h3>
                    <div class="amount">${{ balance|default:"0" }}</div>
                </div>
            </div>
        </div>
        
        <!-- Budget Section -->
        <div class="budget-section">
            <div class="budget-container">
                <div class="budget-setting">
                    {% if if_budget %}
                    <h3>Budget</h3>
                    <form method="post" action="{% url 'update_budget' %}">
                        {% csrf_token %}
                        <div class="budget-input-group">
                            <input type="number" class="budget-input" name="budget" placeholder="{{ if_budget.budget }}">
                            <button class="set-budget-btn">Update Budget</button>
                        </div>
                    </form>
                    {% else %}
                    <h3>Set Budget for this month</h3>
                    <form method="post" action="{% url 'set_budget' %}">
                        {% csrf_token %}
                        <div class="budget-input-group">
                            <input type="number" class="budget-input" name="budget" placeholder="Set Budget for this month..">
                            <button class="set-budget-btn">Set Budget</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
                
                <div class="budget-usage">
                    {% if if_budget %}
                    <h3>Budget Usage</h3>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style='width: {{ percentage }}%;'></div>
                        </div>
                        <div class="progress-info">
                            <span class="progress-percentage">{{ percentage }}%</span>
                            <span class="progress-amount">${{ month_expense|default:"0" }} / ${{ if_budget.budget|default:"0" }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Line Chart Section (Top) -->
        <div class="line-chart-section">
            <div class="chart-container line-chart">
                <h2>Income vs Expenses Trend</h2>
                <div class="line-chart-content">
                    {% if line_chart %}
                        <img src="data:image/png;base64,{{ line_chart }}" alt="Income vs Expenses Chart" class="chart-image line-chart-image">
                    {% else %}
                        <div class="chart-placeholder line-chart-placeholder">
                            <canvas id="lineChart" width="800" height="300"></canvas>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Charts Section (Bar Chart and Pie Chart) -->
        <div class="charts-section">
            <div class="chart-container overview-chart">
                <h2>Expense Overview</h2>
                <div class="chart-content">
                    {% if bar_chart %}
                        <img src="data:image/png;base64,{{ bar_chart }}" alt="Overview Chart" class="chart-image">
                    {% else %}
                        <div class="chart-placeholder">
                            <canvas id="overviewChart" width="400" height="200"></canvas>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="chart-container pie-chart">
                <h2>Expenses by Category</h2>
                <div class="chart-content">
                    {% if pie_chart %}
                        <img src="data:image/png;base64,{{ pie_chart }}" alt="Category Chart" class="chart-image">
                    {% else %}
                        <div class="chart-placeholder">
                            <canvas id="categoryChart" width="300" height="300"></canvas>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <!-- Recent Transactions -->
            <div class="transactions-section">
                <h2>Recent Transactions</h2>
                <div class="transactions-table">
                    <div class="table-header">
                        <span>Date</span>
                        <span>Category</span>
                        <span>Amount</span>
                        <span>Note</span>
                    </div>
                    {% for transaction in recent_transactions %}
                    <div class="transaction-item">
                        <span>{{ transaction.date }}</span>
                        {% if transaction.source %}
                        <span>{{ transaction.source }}</span>
                        {% else %}
                        <span>{{ transaction.expense_type }}</span>
                        {% endif %}
                        <span>{{ transaction.amount }}</span>
                        {% if transaction.model_name == "income" %}
                        <span style="color:#219150;">income</span>
                        {% elif transaction.model_name == "dailyexpense" %}
                        <span style="color: red;">Expense</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Filters Section -->
             <form method="post" action="{% url 'dashboard' %}">
                {% csrf_token %}
            <div class="filters-section">
                <h2>Select Month</h2>
                <div class="filter-group">
                    <label>Year</label>
                    <select class="filter-select" name="year">
                        <option>2025</option>
                        <option>2024</option>
                        <option>2023</option>
                        <option>2022</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Month</label>
                    <select class="filter-select" name="month">
                        <option>January</option>
                        <option>February</option>
                        <option>March</option>
                        <option>April</option>
                        <option>May</option>
                        <option>June</option>
                        <option>July</option>
                        <option>August</option>
                        <option>September</option>
                        <option>October</option>
                        <option>November</option>
                        <option>December</option>
                    </select>
                </div>
                <button class="add-expense-btn"> Confirm </button>
            </div>
            </form>
        </div>
    </div>

    <!-- Sample Chart Script (fallback for when Django charts aren't available) -->
    <script>
        // Line Chart rendering
        if (document.getElementById('lineChart')) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            const padding = 40;
            
            // Sample data for income and expenses over months
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const incomeData = [2000, 2200, 1800, 2400, 2100, 2500];
            const expenseData = [1500, 1800, 1200, 2000, 1600, 1750];
            
            const maxValue = Math.max(...incomeData, ...expenseData);
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (i * chartHeight / 5);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Draw month labels
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            months.forEach((month, index) => {
                const x = padding + (index * chartWidth / (months.length - 1));
                ctx.fillText(month, x, height - 10);
            });
            
            // Draw income line
            ctx.strokeStyle = '#4CAF50';
            ctx.lineWidth = 3;
            ctx.beginPath();
            incomeData.forEach((value, index) => {
                const x = padding + (index * chartWidth / (incomeData.length - 1));
                const y = height - padding - (value / maxValue) * chartHeight;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw expense line
            ctx.strokeStyle = '#FF5722';
            ctx.lineWidth = 3;
            ctx.beginPath();
            expenseData.forEach((value, index) => {
                const x = padding + (index * chartWidth / (expenseData.length - 1));
                const y = height - padding - (value / maxValue) * chartHeight;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw income points
            incomeData.forEach((value, index) => {
                const x = padding + (index * chartWidth / (incomeData.length - 1));
                const y = height - padding - (value / maxValue) * chartHeight;
                ctx.fillStyle = '#4CAF50';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw expense points
            expenseData.forEach((value, index) => {
                const x = padding + (index * chartWidth / (expenseData.length - 1));
                const y = height - padding - (value / maxValue) * chartHeight;
                ctx.fillStyle = '#FF5722';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw legend
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(padding, 20, 15, 15);
            ctx.fillStyle = '#2c3e50';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Income', padding + 20, 32);
            
            ctx.fillStyle = '#FF5722';
            ctx.fillRect(padding + 100, 20, 15, 15);
            ctx.fillStyle = '#2c3e50';
            ctx.fillText('Expenses', padding + 120, 32);
        }

        // Bar Chart rendering for demo purposes
        if (document.getElementById('overviewChart')) {
            const ctx = document.getElementById('overviewChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, '#4CAF50');
            gradient.addColorStop(1, '#81C784');
            
            // Draw bars for demo
            const data = [1200, 1400, 800, 1800, 1200, 1100, 1900];
            const maxHeight = 160;
            const barWidth = 40;
            const spacing = 10;
            
            data.forEach((value, index) => {
                const height = (value / 2000) * maxHeight;
                const x = index * (barWidth + spacing) + 20;
                const y = 200 - height - 20;
                
                ctx.fillStyle = index % 2 === 0 ? '#4CAF50' : '#FF5722';
                ctx.fillRect(x, y, barWidth, height);
            });
        }

        if (document.getElementById('categoryChart')) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const centerX = 150;
            const centerY = 150;
            const radius = 80;
            
            const data = [
                { label: 'Food', value: 40, color: '#4CAF50' },
                { label: 'Travel', value: 25, color: '#2196F3' },
                { label: 'Shopping', value: 20, color: '#FF9800' },
                { label: 'Bills', value: 15, color: '#9C27B0' }
            ];
            
            let currentAngle = 0;
            data.forEach(item => {
                const sliceAngle = (item.value / 100) * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                
                currentAngle += sliceAngle;
            });
            
            // Draw inner circle for donut effect
            ctx.beginPath();
            ctx.arc(centerX, centerY, 40, 0, 2 * Math.PI);
            ctx.fillStyle = '#f5f5f5';
            ctx.fill();
        }
        
    </script>

</body>
</html>